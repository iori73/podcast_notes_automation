## **基本情報**

- Spotify URL：[エピソードリンク](https://open.spotify.com/episode/6ibx9wzZ9faATF9WlqSA0v?si=0D35E2w2QC67eanRt-A-NQ)
- 公開日：2023年08月23日
- 長さ：17:13
- LISTEN URL：

## **要約**

このエピソードでは、Amazon Prime Videoのストリーミング監視システムをモノレスに改修したカリフォルニアベイエリアのソフトウェアエンジニアたちの事例が取り上げられています。彼らはマイクロサービスからモノレスに移行することで90%のコスト削減を実現したが、このアプローチに対して議論が巻き起こりました。改修により処理コストが削減された一方で、スケーラビリティに制限が生じる点に批判が集まりました。エンジニアたちは、処理のシンプル化やフローの見通しが良くなったと報告していますが、モノリシックなシステムに移行することでスケールアウトが難しくなったという課題も浮上しました。記事では、最適なシステム設計とアーキテクチャ選択が業務に与える影響について考察されています。この事例を通じて、システム設計の重要性と設計の適合性が強調されています。興味深い挑戦によって、システム最適化に必要な考慮事項について深く考えさせられる内容となっています。システム設計やアーキテクチャの最適化に興味のある方にとって、有益なエピソードと言えるでしょう。

## **目次**

04:04 マイクロサービスと機械学習

05:00 スケーラビリティの課題

05:55 キャッシュ機構とシステムの変更

08:08 サーバーレスとラムダファンクションを使用したシステム設計

09:07 効率的なシステムへの設計変更とコスト削減

10:14 技術トレンドへの追随と事業最適化

12:23 設計と開発のトレードオフ

13:18 プロダクトの設計と事業の適合性

14:14 組織構造とプロダクト設計の関連性


## **文字起こし**

こんにちは。 Today Islandではカリフォルニアベイエリアで働くソフトウェアエンジニアが、 気になったトピックを紹介しながらトレンドを追っかけていきます。 今回はAmazon Prime Videoにおいて、 ストリーミング監視システムをマイクロサービスからモノレスに突き切り替えたというブログ記事をもとに、 我々がシステム設計において肝に銘じるべきことについて話しました。 それではどうぞ。 うまいともあきです。サンフランシスコにあるスタートアップでCTOとして働いています。 ゆうすけです。ベイエリアのテックカンパニーでソフトウェアエンジニアをしています。 はい、ということで、今日はシステム設計の話をしたいと思います。 どういう話かと言いますと、システム設計に銀の弾丸は存在しない。 銀の弾丸っていわゆる何にでも効く万能な武器って例えですけど、 そういうものはないよっていう。ないけど、じゃあ我々何ができるのかっていう、 その話を先日あった出来事をもとにお話したいなと思うんですけど、 今回記事がありまして、どういう記事かというと、 Amazon Primeってあるじゃないですか。 はい。 Amazon Primeの動画のやつなんていうんですっけ、Amazon Prime Videoか。 ビデオか。 というのが、テックブログを書いてるんですけど、そこに3月くらいかな、今年の。 3月くらいにAmazon Primeでストリーミングの監視システムのマイクロサービスを モノレスに作り替えて90%コストを削減したっていう記事がまた出たんですよね。 この記事ご存知ですか。 いや、見てないですね。 はい、要はAWS、Amazonってマイクロサービスとかサーバレスとか、 すごい推してたわけじゃないですか。 そうなんですけど、モノレスに作り替えて90%コストをカットしたっていう。 結論から言っちゃうと、この記事自体がクリックベイトなんですよね。 日本語で言うとクリックベイトはタイトルがつりみたいな。 タイトルがつり。 なんですけど、これを見てですね、いろんな人が反応したわけなんですよ。 特に一番有名なのがDHHっていうRuby on Railsの作者の人で、 モノレス的なのを推してる人が直後にブロック記事を書いて、 Amazonすらサーバレスやマイクロサービスを買いこなせてないみたいな。 だから、このマイクロサービスとかサーバレスっていうのは結局役に立たないんだみたいな感じの批判的な。 彼はもちろんモノレスとかRuby on Railsのスペシャリストというか、 それを全力で推してる人なんで、当然のようにそうやって言うんですけど、 あんまりその記事とかも読んでない人たちも結構タイトルに反応して、 サーバレス終わったとかマイクロサービスはもうダメだとか、 いろんな批判的なコメントが出てきたというところなんですけど、 もうちょっとこの記事の概要を先にちょっと説明して、 実際のところどうだったのかっていう話をちょっとしたいんですけど、 記事の話、もうちょっとちゃんとブログを読んだ上で話を紹介すると、 まずこのAmazonプライムのシステムってどういうものかっていうと、 さっき言った通りでストリームの品質を監視するシステムなんですよ。 動画を視聴していた時に、動画って時にジャギーになったりとかブロック落ちたりとかするじゃないですか、 あった時にそれを検知してそれを改善するようなトリガーを発行して、 画質を元に戻すみたいなことをするシステムなんですね。 だからいろんな人たちが世界中で見ているわけなんですけど、 それをバーってリアルタイムでモニターしてるんですよ。 それを一個のストリームとして受け取りつつ、 画像とあと音ですね、音のフレームみたいなバッファーみたいな形で受け取って、 それをマシンラーニングでチェックして、 何か問題がありそうだってことをマシンラーニングで判断したら、 数値みたいのを出すみたいな仕組みなんですね。 これは全部最初のシステムっていうのは、いわゆるマイクロサービスで作られていて、 バッファーをする仕組みっていうのが個別でマイクロサービスとしてあったりとか、 あと検知する仕組みもステップファンクションって言われているもので、 ラムダファンクションってあるんですけど、 ラムダファンクションっていうのは、いわゆるマイクロサービスの最小単位のものなんですけど、 それをオーケストレーション、それを複数連動させて動かせる仕組みがステップファンクションって言うんですけど、 ステップファンクションを使って検知して通知するみたいな仕組みを作ってました。 このシステム自体はもちろん最初はちゃんと動いてたんですけど、 2つの課題があって、1つは検知する仕組みのところですね、 マイクロサービスがボトルネックになっていると、 今言ってたステップファンクションっていうのがAWSの処理限界みたいのが設定されていて、 すごい大量にストリーミングが流れてくると、その処理限界にフィットしてしまうと。 当初予定していたスケーラビリティの5%ぐらいしか実はカバーできないということがわかったと。 かつ、ステップファンクションって、今言ったとおりにラムダファンクションを連ねていくんですけど、 ラムダファンクション同士を状態を渡すごとに課金されるんですよね。 するとリアルタイムでめちゃくちゃデータを集めていると、 データってどんどん変わっていくから、1秒ごとのステップみたいのをどんどん管理していくから、めちゃくちゃお金かかると。 もう1個の問題がバッファーのキャッシュで、さっき言ったとおりで、その画像と音声のデータを取ってきて、 それをマシンラーニングで検知するみたいなことをやっているんですけども、映像からそのバッファーとして撮ってくるみたいなところがあるんですけど、それがそのそれなりに重い処理なので マイクロサービスで別システムにして処理後のデータをS3という、要はストレージに置いてますとです。 他のステップファンクションからそのストレージの方をチェックしてモニターするようにしたんですよね。 そうするとストレージサービスS3なんですけど、これ要はそこにアクセスするために課金が発生するんですよね。 リアルタイムでもちろんそれをやってから、ものすごいお金がかかります。だからそのキャッシングの仕組みは マイクロサービスのコストを下げるために導入したけど、結果的にS3のアクセスでめちゃくちゃお金がかかってたっていうのが 2つの大きな課題だったんですよね。 ここまで大丈夫そうですかね。 これを解決しようっていう話で、全ての処理を基本的に一つのシステムで行うようにした。つまり 今言ってたバッファーとかを画像を撮ってきて、 MLで検知して通知するっていうのを一つの インスタンスって言われている、EC2なんですけど、EC2の中で処理するようなモノリティックなシステムにしたんですよね。 で、さっき言ってたバッファーをキャッシュするっていうのもやめて、 画像を撮ってくる、それをメモリに置く、そのメモリにあるデータを直接確認するっていう風な仕組みにしたんですよ。 つまりもう物理的なキャッシュ機構っていうのが必要なくなって、その部分のコストは全くなくなったし、 あとシステムとしてもめちゃくちゃシンプルになったんですよね。もう全部の順番に逐次処理するみたいな形になるから、 キャッシュいらないですとか、フローも分かりやすいですとか、 で、その辺はもちろんバッチリなんですけど、ただその インスタンス自体で一個のモノリティックなシステムになったんで、 結局スケールアップしかできないんですね。スケールアウトができなくなるっていう。 スケールアップっていうのは要はメモリ増やすとか、CPUを強くするとか、 そういうところになるんですけど、それしか基本的にできなくなって、 それはそれでまた上限にヒットしてしまうということで、結局そのフロントのところに ラムダファンクションを置いて、ラムダファンクションでデータをさばいて、 複数のインスタンスを立てて、同じ仕組みの複数のインスタンスを立てて、ロードバランサーみたいな感じですね。 そのラムダファンクションを経由して、データを各インスタンスに渡してさばくようにして、 スケールアウトできるようにしたっていうのが今回の解決策で、結果的に90%のコスト削減になったし、 スケールアウトも、スケーラビリティも改善されましたというところで。 ある意味、ラムダファンクションが出てくるなんていうか、もてはやされる前のよくある構成ですよね。 ロードバランサー敷いて、EC2インスタンス一緒にたくさん置いてみたいな。 そうですね、そんな感じです。 なので、この仕組みって、実際のところは何なのかって話になるんですけど、別に 既存のマイクロシステム、マーキュロサービス、サーバレスのものを モノリシックにしたっていうわけではなくて、ただ単純にストリーミング監視っていう サービス自体で、どうやってそのコストを削減するかって、効率よいシステムに書き換えるかっていう話なんですね。 で、それを調べた結果、キャッシングはいらないよねとか、リアルタイムの処理に ステップファンクション向いていないよねとか、そういうことが分かったから、結果的に、このこれを効率よいシステムに書き換えた。 別にモノリシックにしたっていうところは重要じゃなくて、ただただそのコストを削減したっていうのがすごい大事なところで、 今言ってた通りで、ラムダファンクションも使われてるし、 あとシステム自体も、もちろんサーバレス、多分EC2って言ってるんですけど、 明記されてないけど、おそらくパーゲートとか、そういう クラスタリングとかのところで、何かしらのサーバレスのシステムを使われていると思うんですよね。 だから、すごいこのタイトルと記事と概要だけ読むと サーバレス終わったみたいな、なんかそういう反応しがちなんですけど、いやいや全然違うよっていうのが実際のところですと。 で、多分ここから得られる重要な話っていうのは、システムの設計に完璧なものってなくて、よくまあこれからは マイクロサービスだとか、これからはモノレシックだとか、何かあれじゃないですか、 モバイルアプリケーションでも、何とかアーキテクチャ、そう、いっぱいあるじゃないですか。 だけど、それは銀の弾丸じゃないんですよね。そういうの全く存在しないんですよ。 ただし、事業にあった設計っていうのは存在するんですよね。 だから、今回のパターンだと、リアルタイムストリーミングの監視システムっていうサービスがあって、 それに最適な設計っていうのはあって、で、それは今回のケースだと、 ステップファンクションとかそういうことを使うものではなかった。 あとはキャッシュすることではなかったとか、そういうところが出来事からの学び。 で、結構やっぱりエンジニアとしてはトレンドとか追っかけなきゃってことで、 アクバネティスって何だろうとか、マイクロサービスって何だろうとか、まあそれ以外いろいろあるじゃないですか。 そういうの反応しがちなんですけど、それは常に学び続けることはとっても大事だと思うんですけど、 そういった技術要素に引っ張られるんじゃなくて、事業として何が最適なのかっていうのを常に 考えられるように、まあ引き出しとしていろんなものを持っていくってことは大事なのかなと、 一連の出来事を見て思いましたという話でした。 なんかあれですね、そのやっぱり、今トレンドになっているものは何かとかを知らないと、 知るといいことって、こういう設計の仕方もあるんだって、 今井さんが言ったように、引き出しは増えるっていう意味ではいいんですけどね。 けど、なんかまあ結局のところそれは一つのソリューションでしかないので、それを、あとやっぱエンジニアやってると新しいものに興味が湧いてきて 使ってみたいみたいのありませんかね? うん、わかりました。 自分は結構昔はそういうのが強くて、なんとかアーキテクチャーみたいのもやっぱすごい興味があって、いろいろ調べたり 実際にプロダクションでも導入してみたりとかしたんですけど、なんかまあ今考えるとそれはあんまりいい選択でもなかったかもしれないなとちょっと思っていて 反省というか気をつけたいなぁみたいなところがあって、特にスタートアップはとにかく早くシップするみたいなのが大事なところがあって 結構そういうトレードオフみたいなのはよくあるんですよね。設計に妥協するというか、とりあえず一旦動くものを作るみたいなところとかはあるんですけど それはそれでいいのかなっていうのは常に最近というかずっと思っていて、それはなぜかというと事業に合った設計だから だけどまあもちろんそこから事業が大きくなったら、そういうものっていうのはどんどん変えていかなきゃいけないし、だから変えられる仕組みみたいのはちゃんと検討しておくとかは大事かなみたいな そんな風に。どっちかというとあれですよね、うちもちょっと似てるのは、新しいフレームワークとかが出てくる時ってお試しビルドフェーズ お試しプロダクトに使ってもらうフェーズ、レコメンデーションフェーズ、でカンパニーで今日みんな使ってねフェーズみたいな分かれてるんですけど やっぱ最初のフェーズのプロダクトインフラストラクチャーとかって荒いですよね、荒いしやっぱり事業内容によって今流行りのなんとかアーキテクチャーみたいな を使えないぐらい大きいアプリだったりするので、思っているような最適解なんですか、よく言われるような最適解とは違う構成だったりしますよね そうですね、特に大きなサービスだったりするとやっぱりその事業に多分合った福利になってると思うんですよね あとはあるいは組織ですね、よくコンウェイの法則か、コンウェイの法則ってあるじゃないですか、設計が組織にに通ってくるみたいな だから組織構造とかも大きくなると、大きくなったりすごいこう変わってきたりすると、それに合わせた形にプロダクトの設計とかも変わってくるんじゃないかな ありますよ、プロダクトによって色違いますよね じゃあそこになんちゃらアーキテクチャーを入れようって言っても、多分うまくなじまないですよ 思います、なのでどっちかというと、その中でもエンジニアリングとして気をつけるといいよねみたいなことってあるじゃないですか なんか何だろう、できることなら一つのクラスにたくさんのものを入れ込みすぎないとか なんかどことどこを線引きした方が、今後アーキテクチャーとかその形を変えようと思った時にやりやすいかとか、なんかあると思うんですよね で、プラス大事になってくるスキルって、じゃあある一定のフェーズを超えた時にそれをもうちょっと一般的な形に変えたいっていうリファクタリングができるかとか なんかそういうスキルの方が一発目からちゃんと綺麗に描けることよりも大事だったりしますよね ほんとその通りですね 意外とそのなんか既存の複数のコードベースから大事な要素だけを取り出して、それを共通化するっていう練習をしているエンジニアって少ないような気がしてて なんか僕の観測なんですけど、スキルなんでしょそれもね そうですね、だからあとそのユスケさんが今言ってた、プリンシプルみたいなもやっぱり持っておくべきですよね、学んでおくべきですよね そっちの方は絶対大事だと思いますよ まあでもそれは過去のたくさんの間違いがあるからたどり着いてる結果なのかもしれないからまあなんとも言えないですけど あの時RXスイフトなんて使わなくてよかったのにかっこいいから使っちゃったなとか ありますね、あれはまあまあけどあれはあれで役に立つ部分もあったのかな ちょっとこう言ってみますけど、そうですよねほんと知らぬ通りで はいそんなところでよろしいでしょうか はい、本日はシステム設計に銀の弾丸は存在しないという話をしました よかったら感想をハッシュタグTodayIlearnedFMでつぶやいてください それではありがとうございました ありがとうございました、これタイトル我々のこのタイトルはクリックベイトではないんですかね どうでしょう、クリックベイトかもしれない いいですね、ありがとうございます ありがとうございました
